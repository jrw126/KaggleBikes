---
title: "Untitled"
author: "John Wright"
date: "Wednesday, February 11, 2015"
output: html_document
---

```{r}
library(party)
library(randomForest)
library(lubridate)
library(lattice)
library(gbm)
library(ProgGUIinR)
library(nnet)

setwd("C:\\Users\\jwright\\Desktop\\p5")

train <- read.csv("train.csv", header = T)
test <- read.csv("test.csv", header = T)

```


# prepare data
```{r}

# fix data types
cleaner <- function(x) {
      x$datetime <- as.POSIXct(x$datetime)
      x[, 2:5] <- lapply(x[, 2:5], factor)
      x[, c(6:7, 9)] <- lapply(x[, c(6:7, 9)], as.numeric)
      x[, 8] <- lapply(x[, 8], function(x) as.integer(as.character(x)))
      x
}

train <- cleaner(train); test <- cleaner(test)

# generate new features
dataPrep <- function(x) {
      x$year <- factor(year(x$datetime))
      x$month <- factor(months(x$datetime))
      x$week <- factor(with(x, week.of.month(year(datetime),
                                             month(datetime),
                                             day(datetime))))
      x$day <- factor(weekdays(x$datetime))
      x$daynum <- factor(day(x$datetime))
      x$hour <- factor(as.integer(format(x$datetime, format = "%H")))
      x$is_sun <- factor(ifelse(x$day == "Sunday", 1, 0))
      x$is_sat <- factor(ifelse(x$day == "Saturday", 1, 0))
      
      ## Holiday Adjustments ######################################################
      # xmas / NYE
      x$holiday[x$month == "December" & x$daynum %in% c(23, 24, 25, 26, 31)] <- 1
      
      # thanksgiving
      x$holiday[x$month == "November" & x$week == 3 & (x$day == "Wednesday" |
                                                      x$day == "Thursday" | 
                                                      x$day == "Friday")] <- 1
      
      # halloween
      x$holiday[x$month == "October" & x$daynum == 31] <- 1
      
      # labor day
      x$holiday[x$month == "September" & x$week == 1 & x$day == "Monday"] <- 1
      
      # independence day
      x$holiday[x$month == "July" & x$daynum == 4] <- 1
      
      # memorial day
      x$holiday[x$month == "May" & x$day == "Monday" & x$week == 4] <- 1
      
      # pres day
      x$holiday[x$month == "February" & x$weeknum == 3 & x$day == "Monday"] <- 1
      
      # MLK day
      x$holiday[x$month == "January" & x$week == 3 & x$day == "Monday"] <- 1
      
      # new years day
      x$holiday[x$month == "January" & x$daynum == 1] <- 1
      
      # superbowl
      x$holiday[x$month == "February" & x$daynum == 6 & x$year == 2011] <- 1
      x$holiday[x$month == "February" & x$daynum == 5 & x$year == 2012] <- 1
      
      # Washington DC Marathon
      x$holiday[x$month == "March" & x$daynum == 17 & x$year == 2012] <- 1
      x$holiday[x$month == "March" & x$daynum == 26 & x$year == 2011] <- 1
      #############################################################################
      
      for (d in unique(x$day)) {
            x[, d] <- factor(ifelse(x$day == d, 1, 0))
      }
      for (m in unique(x$month)) {
            x[, m] <- factor(ifelse(x$month == m, 1, 0))
      }
      x$temp_b <- cut(x$temp, 
                      breaks = c(0, 10, 15, 24, 31, 100),
                      labels = c("cold", "chilly", "comfortable", "warm", "hot"))
      x$atemp_b <- cut(x$atemp, 
                       breaks = c(0, 10, 15, 24, 31, 100),
                       labels = c("cold", "chilly", "comfortable", "warm", "hot"))
      x$windy <- factor(ifelse(x$windspeed > 35, 1, 0))
      x$timerange <- cut(as.numeric(x$hour),
                         breaks = c(0, 7, 12, 17, 21, 24),
                         labels = c("early", "morning", "afternoon", "evening", "night"))
      x$busy <- "verylow"
      x$busy[x$hour %in% c(0, 6, 22, 23)] <- "low"
      x$busy[x$hour %in% c(9, 10, 20, 21)] <- "moderate"
      x$busy[x$hour %in% c(7, 11, 12, 13, 14, 15, 16, 19)] <- "high"
      x$busy[x$hour %in% c(8, 17, 18)] <- "veryhigh"
      x$busy <- factor(x$busy)
      
      # total stations
      x$stations <- 0
      x$stations[x$datetime > "2011-04-11"] <- 25
      x$stations[x$datetime > "2011-07-27"] <- 57
      x$stations[x$datetime > "2012-03-16"] <- 59
      x$stations[x$datetime > "2012-10-30"] <- 117
      x$stations <- factor(x$stations)
      
      x
      
}

train[, c("registered", "casual")] <- lapply(train[, c("registered", "casual")], log1p)
train <- dataPrep(train); test <- dataPrep(test)

# http://blog.dato.com/using-gradient-boosted-trees-to-predict-bike-sharing-demand
# http://beyondvalence.blogspot.com/2014/06/predicting-capital-bikeshare-demand-in.html

# exploratory graphs
xyplot(expm1(casual) ~ 1:nrow(train) | hour, data = train, group = workingday)

```

# model
```{r}
set.seed(123)

# model formula
trainVars <- "~ year + season + holiday + workingday + weather + 
              hour + atemp_b + windy + 
              is_sat + is_sun + month + day +
              timerange + busy + temp_b"

# fit the models

# randomforest
rf.fit.reg <- randomForest(as.formula(paste("registered", trainVars)), train)
rf.fit.cas <- randomForest(as.formula(paste("casual", trainVars)), train)
rf.pred.reg <- expm1(predict(rf.fit.reg, test))
rf.pred.cas <- expm1(predict(rf.fit.cas, test))

# neural net
nn.fit.reg <- nnet(as.formula(paste("registered", trainVars)), train, size = 10)

nn.pred.reg <- expm1(predict(nn.fit.reg, test))

preds <- rowSums(data.frame(rf.pred.reg, rf.pred.cas), na.rm = T)

# submission output file
submit <- data.frame(datetime = test$datetime, count = as.integer(preds))
# write.csv(submit, "bag_20150225.csv", row.names = F)
# FIND A WAY TO ADJUST FOR XMAS/NYE AND THXGIVING - THESE ARE NOT IN TRAIN SET
### maybe: if month == november & day = thursday & week = 3 then holiday = 1?
# the company was expanding throughout the time period. find a way to adjust
# for total number of stations
# http://www.capitalbikeshare.com/news/2012/10
# next add neural network

```

# old stuff
```{r}


# ctree
# ctree.fit.reg <- ctree(as.formula(paste("registered", trainVars)), train)
# ctree.fit.cas <- ctree(as.formula(paste("casual", trainVars)), train)
# ctree.pred.reg <- expm1(predict(ctree.fit.reg, test))
# ctree.pred.cas <- expm1(predict(ctree.fit.cas, test))

# # gbm
# gbm.fit.reg <- gbm(as.formula(paste("registered", trainVars)), data = train)
# gbm.fit.cas <- gbm(as.formula(paste("casual", trainVars)), data = train)
# gbm.pred.reg <- expm1(predict(gbm.fit.reg, newdata = test,
#                               n.trees = gbm.fit.reg$n.trees))
# gbm.pred.cas <- expm1(predict(gbm.fit.cas, newdata = test,
#                               n.trees = gbm.fit.cas$n.trees))

# average the models together
# preds <- rowMeans(data.frame(ctree = (ctree.pred.reg + ctree.pred.cas),
#                              rf = (rf.pred.reg + rf.pred.cas)
#                              ), na.rm = T)



