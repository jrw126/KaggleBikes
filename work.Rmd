---
title: "Untitled"
author: "John Wright"
date: "Wednesday, February 11, 2015"
output: html_document
---

```{r}
library(party)
library(randomForest)
library(lubridate)

setwd("C:\\Users\\jwright\\Desktop\\p5")

train <- read.csv("train.csv", header = T)
test <- read.csv("test.csv", header = T)

```


# prepare data
```{r}

# fix data types
cleaner <- function(x) {
      x$datetime <- as.POSIXct(x$datetime)
      x[, 2:5] <- lapply(x[, 2:5], factor)
      x[, c(6:7, 9)] <- lapply(x[, c(6:7, 9)], as.numeric)
      x[, 8] <- lapply(x[, 8], function(x) as.integer(as.character(x)))
      x
}

train <- cleaner(train); test <- cleaner(test)

# generate new features: weekday and hour, bins of temp and windspeed
dataPrep <- function(x) {
      x$year <- factor(year(x$datetime))
      x$month <- factor(months(x$datetime))
      x$day <- factor(weekdays(x$datetime))
      x$hour <- factor(as.integer(format(x$datetime, format = "%H")))
      x$is_sun <- factor(ifelse(x$day == "Sunday", 1, 0))
      x$atemp_b <- cut(x$atemp, 
                       breaks = c(0, 10, 15, 24, 31, 100),
                       labels = c("cold", "chilly", "comfortable", "warm", "hot"))
      x$windy <- factor(ifelse(x$windspeed > 35, 1, 0))
      x$timerange <- cut(as.numeric(x$hour),
                         breaks = c(0, 7, 12, 17, 21, 24),
                         labels = c("early", "morning", "afternoon", "evening", "night"))
      x$busy <- "verylow"
      x$busy[x$hour %in% c(0, 6, 22, 23)] <- "low"
      x$busy[x$hour %in% c(9, 10, 20, 21)] <- "moderate"
      x$busy[x$hour %in% c(7, 11, 12, 13, 14, 15, 16, 19)] <- "high"
      x$busy[x$hour %in% c(8, 17, 18)] <- "veryhigh"
      x$busy <- factor(x$busy)
      x
}

train <- dataPrep(train); test <- dataPrep(test)

# exploratory graphs
xyplot(count ~ 1:nrow(train) | hour, data = train, group = workingday)

```

# model
```{r}
# model formula
trainVars <- "~ year + month + season + holiday + workingday + weather + day + 
              hour + is_sun + atemp_b + windy + timerange + busy"

# fit the models

# ctree
ctree.fit.reg <- ctree(as.formula(paste("registered", trainVars)), train)
ctree.fit.cas <- ctree(as.formula(paste("casual", trainVars)), train)
ctree.pred.reg <- predict(ctree.fit.reg, test)
ctree.pred.cas <- predict(ctree.fit.cas, test)

# randomforest
rf.fit.reg <- randomForest(as.formula(paste("registered", trainVars)), train)
rf.fit.cas <- randomForest(as.formula(paste("casual", trainVars)), train)
rf.pred.reg <- predict(rf.fit.reg, test)
rf.pred.cas <- predict(rf.fit.cas, test)

# average the models together
preds <- rowMeans(data.frame(ctree = (ctree.pred.reg + ctree.pred.cas),
                             rf = (rf.pred.reg + rf.pred.cas)
                             ), na.rm = T)

# submission output file
submit <- data.frame(datetime = test$datetime, count = as.integer(preds))
# write.csv(submit, "bag_20150219.csv", row.names = F)

```




