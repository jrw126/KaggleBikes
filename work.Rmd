---
title: "Untitled"
author: "John Wright"
date: "Wednesday, February 11, 2015"
output: html_document
---

```{r}
library(party)
library(randomForest)
library(lubridate)
library(lattice)
library(gbm)
library(ProgGUIinR)

setwd("C:\\Users\\jwright\\Desktop\\p5")

train <- read.csv("train.csv", header = T)
test <- read.csv("test.csv", header = T)

```


# prepare data
```{r}

# fix data types
cleaner <- function(x) {
      x$datetime <- as.POSIXct(x$datetime)
      x[, 2:5] <- lapply(x[, 2:5], factor)
      x[, c(6:7, 9)] <- lapply(x[, c(6:7, 9)], as.numeric)
      x[, 8] <- lapply(x[, 8], function(x) as.integer(as.character(x)))
      x
}

train <- cleaner(train); test <- cleaner(test)

# generate new features
dataPrep <- function(x) {
      x$year <- factor(year(x$datetime))
      x$month <- factor(months(x$datetime))
      x$week <- factor(with(x, week.of.month(year(datetime),
                                             month(datetime),
                                             day(datetime))))
      x$day <- factor(weekdays(x$datetime))
      x$hour <- factor(as.integer(format(x$datetime, format = "%H")))
      x$is_sun <- factor(ifelse(x$day == "Sunday", 1, 0))
      x$is_sat <- factor(ifelse(x$day == "Saturday", 1, 0))
      for (d in unique(x$day)) {
            x[, d] <- factor(ifelse(x$day == d, 1, 0))
      }
      for (m in unique(x$month)) {
            x[, m] <- factor(ifelse(x$month == m, 1, 0))
      }
      x$temp_b <- cut(x$temp, 
                      breaks = c(0, 10, 15, 24, 31, 100),
                      labels = c("cold", "chilly", "comfortable", "warm", "hot"))
      x$atemp_b <- cut(x$atemp, 
                       breaks = c(0, 10, 15, 24, 31, 100),
                       labels = c("cold", "chilly", "comfortable", "warm", "hot"))
      x$windy <- factor(ifelse(x$windspeed > 35, 1, 0))
      x$timerange <- cut(as.numeric(x$hour),
                         breaks = c(0, 7, 12, 17, 21, 24),
                         labels = c("early", "morning", "afternoon", "evening", "night"))
      x$busy <- "verylow"
      x$busy[x$hour %in% c(0, 6, 22, 23)] <- "low"
      x$busy[x$hour %in% c(9, 10, 20, 21)] <- "moderate"
      x$busy[x$hour %in% c(7, 11, 12, 13, 14, 15, 16, 19)] <- "high"
      x$busy[x$hour %in% c(8, 17, 18)] <- "veryhigh"
      x$busy <- factor(x$busy)
      x
}

train[, c("registered", "casual")] <- lapply(train[, c("registered", "casual")], log1p)
train <- dataPrep(train); test <- dataPrep(test)

# http://blog.dato.com/using-gradient-boosted-trees-to-predict-bike-sharing-demand
# http://beyondvalence.blogspot.com/2014/06/predicting-capital-bikeshare-demand-in.html

# exploratory graphs
xyplot(count ~ 1:nrow(train) | week, data = train, group = month)

```

# model
```{r}
set.seed(123)

# model formula
trainVars <- "~ year + season + holiday + workingday + weather + 
              hour + atemp_b + windy + 
              is_sat + is_sun + month + day +
              timerange + busy + temp_b"

# fit the models

# randomforest
rf.fit.reg <- randomForest(as.formula(paste("registered", trainVars)), train)
rf.fit.cas <- randomForest(as.formula(paste("casual", trainVars)), train)
rf.pred.reg <- expm1(predict(rf.fit.reg, test))
rf.pred.cas <- expm1(predict(rf.fit.cas, test))

preds <- rowSums(data.frame(rf.pred.reg, rf.pred.cas), na.rm = T)

# submission output file
submit <- data.frame(datetime = test$datetime, count = as.integer(preds))
# write.csv(submit, "bag_20150223.csv", row.names = F)
# NEXT TEST: DO NOT CONVERT TO INTEGER

```

# old stuff
```{r}


# ctree
# ctree.fit.reg <- ctree(as.formula(paste("registered", trainVars)), train)
# ctree.fit.cas <- ctree(as.formula(paste("casual", trainVars)), train)
# ctree.pred.reg <- expm1(predict(ctree.fit.reg, test))
# ctree.pred.cas <- expm1(predict(ctree.fit.cas, test))

# # gbm
# gbm.fit.reg <- gbm(as.formula(paste("registered", trainVars)), data = train)
# gbm.fit.cas <- gbm(as.formula(paste("casual", trainVars)), data = train)
# gbm.pred.reg <- expm1(predict(gbm.fit.reg, newdata = test,
#                               n.trees = gbm.fit.reg$n.trees))
# gbm.pred.cas <- expm1(predict(gbm.fit.cas, newdata = test,
#                               n.trees = gbm.fit.cas$n.trees))

# average the models together
# preds <- rowMeans(data.frame(ctree = (ctree.pred.reg + ctree.pred.cas),
#                              rf = (rf.pred.reg + rf.pred.cas)
#                              ), na.rm = T)



